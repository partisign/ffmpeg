# Video converter test task

Решение тестового задания
Сервис принимает видео файл .mov, новертирует его в .mp4 и возвращает ссылку для скачивания на конвертируемый файл.

## Установка

```
npm i
npm run start
```

## Эндпоинты

### POST /upload

принимает файл .mov в поле **_video_**, в случае успешной конвертации возвращает ссылку на скачивание сконевртированного видео

### GET /download/:fileNmae

отдает файл или ошибку, если файл не найден

## Описание логики работы приложения

### Общая структура приложения

- **Точка входа** - app.js. Создается сервер (используем express), подключается роутер. Сервер слушает порт из .env или 3000 (по умолчанию).
- **Роутер** (router/index.js) - два эндпоинта (POST /upload, GET /download/:fileName)
- **Контроллеры** инстансы классов создаются в роутере и передаются в качестве колбеков обработки маршрутов, в марштуте upload так же добавляется multer в качестве middleware. В конструктор классов можно передать инстанс сервиса (по умолчанию применяется инстанс готово)
- - **UploadController** - по умолчанию констурктор принимает инстанс UloadService. Класс контроллера реализует единственный метод `uploadVideo(req, res)`, который внутри себя вызывает значала метод сервиса для проверки видео на валидность формата, и потом метод сервиса, который ставит видео в очередь на обработку
- - - **_UploadService_** - конструктор принимает _uploadDir_ - папку, в которой сохраняются исходные файлы, и _convertedDir_ - папку, куда будут сложены конвертированные файлы. По-умолчанию данные в констурктор забираются из config файла.
      Класс реалзиует 3 метода: **_checkVideoFormat_** - проверяет файл на соответствие формату (доступные форматы описаны в файле config) использует ffmpeg.probe (нагрузки на цпу нет - внутри метод использует обычное чтение из файла метаданных - с этим справляется libuv, поэтому проверка до воркеров - что бы не создават их лишний раз), **_addTask_** - постановка задачи на конвертацию файла, **_processQueue_** - метод упарвления очередью задач и пулом воркеров (метод создает и удаляет воркеры, управляет очередью задач на конвертацию)
- - - - **_ConvertWorker_** - Вокрер, который выполняет тяжелую (нагрузка на CPU) задачу по конвертации видео (использует ffmpeg библиотеку).
- - **DowloadController** - класс контроллера для отдачи видео по имени файла. Конструктор прининмает инстанс класса DoqnloadService (можно не передавать, по умолчанию передается существующий инстанс). Класс реализиует единственный метод `downloadFile(fileName)`, внутри метод вызывает метод класса DownloadService.
- - - **DownloadService** - конструктор класса принимает путь к папке с конвертированными файлами (по умолчанию значение забирается из config файла). Реализует два метода - `downloadFile`и `deleteFile`.

## Структура проекта

```

ffmpeg/
│
├─ config/
│ └── config.js
│
├─ controllers/
│ ├── download.controller.js
│ └── upload.controller.js
│
├─ middlewares/
│ └── multer.middleware.js
│
├─ router/
│ └── index.js
│
├─ services/
│ ├── download.service.js
│ └── upload.service.js
│
├─ workers/
│ └── convert.worker.js
│
├ .gitignore
├  app.js
├  example.env
├  package-lock.json
├  package.json
└  README.md
```
